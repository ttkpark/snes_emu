---
alwaysApply: true
---

프로그램 빌드할때는 루트 디렉토리의 `./build_complete.bat` 파일을 활용해
프로그램 실행할때는 루트 디렉토리의 `./snes_emu_complete.exe`으로 실행해. 

## 프로젝트 목표
SNES 에뮬레이터를 만드는 것이 목표입니다. 완전한 SNES 하드웨어 에뮬레이션을 통해 SNES 게임과 테스트 ROM을 실행할 수 있도록 구현합니다.

## 아키텍처 구조

### CPU (65C816)
- **위치**: `src/cpu/`
- **기능**: 메인 CPU 에뮬레이션
- **특징**: 16비트 모드 지원, 100+ 명령어, 인터럽트 처리 (NMI, IRQ, BRK)
- **주소 공간**: 24비트 (16MB)
- **레지스터**: A, X, Y, SP, PC, P (상태 플래그)

### PPU (Picture Processing Unit)
- **위치**: `src/ppu/`
- **기능**: 비디오 처리 및 렌더링
- **특징**: SDL2 비디오 출력, 256x224 해상도, NMI 시스템, 배경 렌더링
- **레지스터**: 0x2100-0x21FF 범위의 PPU 레지스터 처리

### APU (Audio Processing Unit)
- **위치**: `src/apu/`
- **기능**: 오디오 처리 및 SPC700 CPU 에뮬레이션
- **특징**: 
  - **SPC700 CPU**: 8비트 프로세서, 64KB ARAM, I/O 포트 ($F4-$F7)
  - **DSP**: 디지털 신호 프로세서, 8채널 오디오
  - **BRR 디코딩**: Bit Rate Reduction 오디오 디코딩
  - **SDL2 오디오**: 완전한 SDL2 오디오 출력
- **CPU-APU 통신**: I/O 포트를 통한 통신 ($2140-$2143 CPU 측, $F4-$F7 APU 측)

### Memory 시스템
- **위치**: `src/memory/`
- **기능**: 메모리 관리 및 DMA
- **특징**: LoROM 매핑, 8채널 DMA, 128KB WRAM, I/O 라우팅

## 테스트 진행 상황

### 완료된 테스트
- **CPU 테스트**: `cputest-basic.sfc`, `cputest-full.sfc` - 65C816 CPU 명령어 테스트 완료
- **기본 SNES 테스트**: `SNES Test Program.sfc` - 기본 시스템 테스트 완료

### 진행 중인 테스트
- **SPC700 테스트**: `spctest.sfc` - SPC700 명령어 세트 종합 테스트 진행 중
  - **테스트 내용**: 모든 SPC700 opcode (SLEEP, STOP 제외), 모든 주소 모드, 플래그 동작
  - **현재 상태**: 첫 번째 테스트 세트 (`spc_tests0.asm`) 실행 중
  - **현재 문제**: `spc_common.inc`의 `main` 루틴에서 실패 발생
    - SPC가 `fail` 루틴으로 진입하여 무한 루프에 빠짐
    - CPU는 APU 포트 0이 0이 되기를 기다리지만, SPC가 포트 0을 0x03으로 설정한 후 무한 루프
    - 원인 분석 중: `cmp $f5, #$01` 명령어 실행 시 문제 발생 가능성

### 테스트 파일 구조
- **CPU 테스트**: `cputest/` 디렉토리
- **SPC700 테스트**: `spctest/` 디렉토리
  - `spc_common.inc`: 공통 SPC700 루틴 (main, init_test, success, fail)
  - `spc_tests0.asm`, `spc_tests1.asm`, `spc_tests2.asm`: 테스트 케이스들
  - `spctest.asm`: 메인 CPU 코드

## 현재 디버깅 작업
- SPC700 테스트 실패 원인 분석 중
- APU trace 로그 (`apu_trace.log`) 분석하여 SPC700 실행 흐름 추적
- CPU-APU 포트 통신 검증 중
- SPC700 명령어 실행 및 플래그 처리 검증 중 


프로그램 실행 시 `.\snes_emu_complete.exe spctest.sfc`로 실행하고, 백그라운드 실행 시 `Start-Process`를 사용해.

## 프로그램 종료 확인 방법

프로그램이 끝났는지 확인하는 방법:

### 1. 프로세스 확인
```powershell
$process = Get-Process -Name "snes_emu_complete" -ErrorAction SilentlyContinue
if ($process) { "실행 중" } else { "종료됨" }
```

### 2. 로그 파일 업데이트 확인
```powershell
$lastSize = (Get-Item "apu_trace.log").Length
Start-Sleep -Seconds 3
$newSize = (Get-Item "apu_trace.log").Length
if ($newSize -eq $lastSize) { "멈춤" } else { "실행 중" }
```

### 3. 표준 출력 메시지
프로그램 종료 시 다음 메시지 출력:
- `"Emulation finished."`
- `"Total CPU instructions executed: <숫자>"`
- 테스트 실패 시: `"=== SPC TEST FAILED - Reached final loop ==="`

### 4. 포트 2 값 확인
```powershell
$lastPort2 = Select-String -Path "apu_trace.log" -Pattern "wrote port 2 = 0x" | Select-Object -Last 1
```
- `0x2`: 테스트 실패
- `0x3`: fail 루틴 진입
- `0xf3` 등: 테스트 진행 중 (테스트 번호)

## 종료 판단 기준
프로그램이 종료된 것으로 판단:
1. 프로세스가 종료됨
2. "Emulation finished." 메시지 출력
3. 로그 파일이 3초 이상 업데이트되지 않음
4. 포트 2 값이 0x2 또는 0x3으로 설정됨
