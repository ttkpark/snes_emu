# Audio Processing Unit (APU) 구성 요소

SNES의 Audio Processing Unit은 다음 구성 요소들로 이루어져 있습니다:

## 1. Sony SPC700
- **역할**: APU의 메인 CPU
- **기능**: 
  - SPC700 명령어 실행
  - ARAM 접근 제어
  - DSP 레지스터 제어
  - I/O 포트 통신 ($F4-$F7)
- **구현 상태**: ✅ 완료
  - 모든 SPC700 opcode 구현 완료 (256개)
  - IPL (Initial Program Loader) 프로토콜 구현
  - 인터럽트 처리

## 2. S-DSP (Digital Signal Processor)
- **역할**: 디지털 신호 처리 및 오디오 생성
- **기능**:
  - 8개 오디오 채널 처리
  - BRR (Bit Rate Reduction) 디코딩
  - ADSR 엔벨로프 생성
  - 피치 조정 및 샘플 재생
  - 에코/리버브 효과 처리
  - 마스터 볼륨 제어
- **레지스터 (128개)**:
  - **0x00-0x0F**: 채널별 레지스터 (8개 채널 × 2바이트)
    - `0x00, 0x10, 0x20, ... 0x70`: VOL (L) - 왼쪽 볼륨
    - `0x01, 0x11, 0x21, ... 0x71`: VOL (R) - 오른쪽 볼륨
    - `0x02, 0x12, 0x22, ... 0x72`: P (L) - 피치 하위 바이트
    - `0x03, 0x13, 0x23, ... 0x73`: P (H) - 피치 상위 바이트
    - `0x04, 0x14, 0x24, ... 0x74`: SRCN - 소스 번호 (BRR 샘플)
    - `0x05, 0x15, 0x25, ... 0x75`: ADSR (1) - 어택/디케이
    - `0x06, 0x16, 0x26, ... 0x76`: ADSR (2) - 서스테인/릴리즈
    - `0x07, 0x17, 0x27, ... 0x77`: GAIN - 게인 모드
    - `0x08, 0x18, 0x28, ... 0x78`: ∴ENVX - 엔벨로프 레벨 (읽기 전용)
    - `0x09, 0x19, 0x29, ... 0x79`: ∴OUTX - 출력 레벨 (읽기 전용)
  - **0x0C, 0x1C**: MVOL (L/R) - 마스터 볼륨
  - **0x2C, 0x3C**: EVOL (L/R) - 에코 볼륨
  - **0x4C**: KON - 키 온 (채널 활성화)
  - **0x5C**: KOF - 키 오프 (채널 비활성화)
  - **0x6C**: FLG - 플래그 (에코/뮤트 제어)
  - **0x7C**: ∴ENDX - 채널 종료 플래그 (읽기 전용)
  - **0x0D**: EFB - 에코 피드백
  - **0x2D**: PMON - 피치 모뮬레이션
  - **0x3D**: NON - 노이즈 모드
  - **0x4D**: EON - 에코 온
  - **0x5D**: DIR - 디렉토리 (BRR 샘플 테이블 주소)
  - **0x6D**: ESA - 에코 샘플 주소
  - **0x7D**: EDL - 에코 딜레이
- **구현 상태**: 🔄 진행 중
  - 기본 DSP 레지스터 구조 구현됨
  - BRR 디코딩 부분 구현됨
  - ADSR 엔벨로프 처리 필요
  - 피치 조정 및 샘플 재생 로직 개선 필요
  - 에코/리버브 효과 미구현

## 3. APU Oscillator
- **역할**: APU 클럭 생성
- **기능**:
  - X2 클럭 생성 (약 1.024MHz)
  - SPC700 및 DSP 동기화
- **구현 상태**: ✅ 완료
  - CPU 사이클 기반 타이밍 구현

## 4. ARAM (Audio RAM)
- **역할**: 64KB 오디오 메모리
- **기능**:
  - BRR 샘플 데이터 저장
  - SPC700 프로그램 저장
  - DSP 작업 메모리
- **구현 상태**: ✅ 완료
  - 64KB ARAM 구현됨

## 5. Stereo DAC
- **역할**: 디지털-아날로그 변환
- **기능**:
  - 16비트 스테레오 오디오 출력
  - 32kHz 샘플 레이트
- **구현 상태**: ✅ 완료
  - SDL 오디오 출력 구현됨

## 6. Pre-Amplifier
- **역할**: 오디오 신호 전처리
- **기능**:
  - 신호 증폭
  - 노이즈 필터링
- **구현 상태**: ⚠️ 미구현
  - 하드웨어 레벨 구현 불필요 (소프트웨어 에뮬레이션)

## 7. Filter Amplifier
- **역할**: 오디오 필터링
- **기능**:
  - 주파수 필터링
  - 음색 조정
- **구현 상태**: ⚠️ 미구현
  - 하드웨어 레벨 구현 불필요 (소프트웨어 에뮬레이션)

## 8. Post-Amplifier
- **역할**: 최종 오디오 증폭
- **기능**:
  - 최종 출력 레벨 조정
  - 스피커 출력 준비
- **구현 상태**: ⚠️ 미구현
  - 하드웨어 레벨 구현 불필요 (소프트웨어 에뮬레이션)

## I/O 포트 통신
- **CPU → APU**: $2140-$2143 포트를 통해 통신
- **APU → CPU**: $F4-$F7 포트를 통해 통신
- **IPL 프로토콜**: SPC 프로그램 로딩
- **구현 상태**: ✅ 완료
  - IPL 프로토콜 구현됨
  - 포트 읽기/쓰기 구현됨

## 현재 구현 우선순위

### 필수 구현 (PPU 완전한 동작을 위해)
1. ✅ SPC700 CPU - 완료
2. ✅ ARAM - 완료
3. ✅ 기본 DSP 레지스터 구조 - 완료
4. ✅ I/O 포트 통신 - 완료
5. 🔄 BRR 디코딩 - 부분 구현
6. ⚠️ ADSR 엔벨로프 - 개선 필요
7. ⚠️ 피치 조정 - 개선 필요
8. ⚠️ 채널 믹싱 - 개선 필요

### 선택적 구현 (오디오 품질 향상)
1. ⚠️ 에코/리버브 효과
2. ⚠️ 노이즈 생성
3. ⚠️ 피치 모뮬레이션
4. ⚠️ 고급 필터링

## 참고 자료
- [S-DSP 문서](https://sneslab.net/wiki/S-DSP)
- [Audio Processing Unit 문서](https://sneslab.net/wiki/Audio_Processing_Unit)
- [SPC700 Opcode Matrix](https://sneslab.net/wiki/SPC700_Opcode_Matrix)


