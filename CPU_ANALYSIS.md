# CPU 초기화 분석 보고서

## 📊 실행 흐름 요약

### 1단계: 리셋 및 초기화 (0x8000-0x802D)
```
0x8000: SEI (0x78) - 인터럽트 비활성화
0x8001-0x8013: STZ Absolute (0x9C) x7 - I/O 레지스터 초기화
0x8016: LDA #$80 (0xA9) - A = 0x80
0x8018: STA $2100 (0x8D) - INIDISP = 0x80 (Forced Blank ON)
0x801B: CLC (0x18) - Carry 클리어
0x801C: XCE (0xFB) - Native Mode로 전환 (E=0)
0x801D: REP #$38 (0xC2) - M=16bit, X=16bit
0x801F: LDA #$0000 (0xA9) - A = 0
0x8022: TCD (0x5B) - D = 0 (Direct Page)
0x8023: LDA #$01FF (0xA9) - A = 0x01FF
0x8026: TCS (0x1B) - SP = 0x01FF
0x8027: LDA #$F0A9 (0xA9) - A = 0xF0A9
0x802A: STA Long $004200 (0x8F) - NMITIMEN = 0x00
0x802E: LDX #$017D (0xA2) - X = 0x017D
0x8031: LDY #$03FD (0xA0) - Y = 0x03FD
```

### 2단계: WRAM 초기화 루프 (0x8034-0x8048)
```
루프 시작 (0x8034):
  0x8034: LDA #$008D - A = 0x008D
  0x8037: STA Long,X (0x9F) - [X] = 0x008D
  0x803B: TYA (0x98) - A = Y
  0x803C: STA Long,X (0x9F) - [X] = Y
  0x8040: SEC (0x38) - Carry 설정
  0x8041: SBC #$0004 (0xE9) - A = A - 4
  0x8044: TAY (0xA8) - Y = A
  0x8045-0x8047: DEX (0xCA) x3 - X -= 3
  0x8048: BPL (0x10) - X >= 0이면 0x8034로 분기
```

**문제점**: X가 0x017D에서 시작하여 매 루프마다 3씩 감소
- 0x017D → 0x017A → 0x0177 → ... → 0x0003 → 0x0000
- X = 0이 되면 루프 종료 예상
- 하지만 로그에서 X가 0x014D까지 감소한 후 **0x8000으로 리셋**됨!

### 3단계: 무한 리셋 루프 발견!
로그 라인 303-304:
```
[0] PC:0x00803b | Op:0x98 | A:0x008d | X:0x014d | Y:0x03bd
[0] PC:0x008000 | Op:0x78 | A:0x0000 | X:0x0000 | Y:0x0000 | SP:0xff | E:1
```

**CPU가 갑자기 0x8000으로 점프하고 레지스터가 모두 리셋됨!**

## 🔍 사용된 명령어 분석

### 가장 많이 사용된 명령어 (초기 500개)
| Opcode | 명령어 | 횟수 | 구현 상태 |
|--------|--------|------|-----------|
| 0xCA | DEX | 117 | ✅ 구현됨 |
| 0x9F | STA Long,X | 80 | ✅ 구현됨 |
| 0xA9 | LDA Immediate | 53 | ✅ 구현됨 |
| 0x98 | TYA | 40 | ✅ 구현됨 |
| 0xE9 | SBC Immediate | 39 | ✅ 구현됨 |
| 0x38 | SEC | 39 | ✅ 구현됨 |
| 0x10 | BPL | 39 | ✅ 구현됨 |
| 0xA8 | TAY | 39 | ✅ 구현됨 |
| 0x9C | STZ Absolute | 21 | ✅ 구현됨 |

### 레지스터 조작 명령어
| 명령어 | Opcode | 사용 횟수 | 목적 |
|--------|--------|-----------|------|
| XCE | 0xFB | 3 | Emulation ↔ Native 모드 전환 |
| REP | 0xC2 | 3 | 플래그 리셋 (M/X 16bit 설정) |
| TCD | 0x5B | 3 | Direct Page 레지스터 설정 |
| TCS | 0x1B | 3 | Stack Pointer 설정 |
| SEI | 0x78 | 3 | 인터럽트 비활성화 |
| CLC | 0x18 | 3 | Carry 클리어 |

## ❌ 문제점 및 누락된 요소

### 1. **무한 리셋 루프**
- CPU가 WRAM 초기화 중에 갑자기 0x8000으로 리셋됨
- 가능한 원인:
  1. **Watchdog Timer**: 구현되지 않음
  2. **잘못된 메모리 접근**: STA Long,X가 잘못된 주소에 쓰고 있을 가능성
  3. **스택 오버플로우**: SP가 잘못 설정되었을 가능성
  4. **NMI/IRQ 트리거**: 의도하지 않은 인터럽트

### 2. **PPU 레지스터 접근 부족**
- 초기화 단계에서 **단 1개의 PPU 레지스터**만 설정됨:
  - 0x2100 (INIDISP) = 0x80
- 누락된 초기화:
  - BGMODE, Scroll, Tilemap, VRAM 등 모두 설정되지 않음

### 3. **DMA 미사용**
- DMA 레지스터 접근 없음
- 게임이 아직 DMA를 사용하는 단계에 도달하지 못함

## 🎯 다음 단계 권장사항

### 우선순위 1: 무한 리셋 원인 파악
1. **STA Long,X 명령어 검증**
   - X = 0x014D일 때 어디에 쓰고 있는지 확인
   - 잘못된 메모리 영역에 쓰고 있는지 확인

2. **인터럽트 상태 확인**
   - NMI/IRQ가 의도치 않게 트리거되는지 확인
   - 인터럽트 벡터가 올바른지 확인

3. **메모리 보호 구현**
   - ROM 영역에 쓰기 시도 시 경고
   - 잘못된 메모리 접근 로깅

### 우선순위 2: 누락된 CPU 명령어 확인
- 현재 사용된 모든 명령어는 구현되어 있음
- 하지만 명령어 구현에 버그가 있을 가능성

### 우선순위 3: 타이밍 및 동기화
- CPU 사이클 카운팅
- PPU와 CPU 동기화
- V-Blank 타이밍

## 📝 결론

**게임이 초기화를 완료하지 못하는 주요 원인**:
1. ❌ CPU가 WRAM 초기화 중 무한 리셋 루프에 빠짐
2. ❌ PPU 레지스터가 거의 설정되지 않음
3. ✅ 사용된 모든 CPU 명령어는 구현되어 있음

**가장 시급한 문제**: 무한 리셋 루프의 원인 파악 및 수정

